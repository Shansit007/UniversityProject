<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Student Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-right bg-gray-100 font-sans min-h-screen" style="background-image: url('/img/bg.jpg'); background-size:cover; background-position:center;">

  <div class="container mx-auto p-4">

    <!-- Faculty Search -->
    <div class="mb-6">
      <input type="text" id="facultySearch" placeholder="Search faculty by name..."
        class="border p-2 rounded w-full shadow-sm focus:ring-2 focus:ring-blue-400 transition duration-200">
    </div>

    <!-- Faculties List -->
    <div id="facultyList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10"></div>

    <!-- Clubs Section -->
    <h2 class="text-2xl font-bold mb-4">Clubs</h2>
    <div id="clubList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

  </div>

<script>
const studentToken = localStorage.getItem('studentToken'); 
const studentData = JSON.parse(localStorage.getItem('studentData'));

if (!studentToken) {
  alert('You are not logged in. Please login first.');
  window.location.href = '/student-login.html';
}

// --- Fetch Faculties ---
async function fetchFaculties() {
  try {
    const res = await fetch('https://where-is-my-faculty-backend.onrender.com/api/faculty', {
      headers: { 'Authorization': `Bearer ${studentToken}` }
    });
    const data = await res.json();
    displayFaculties(data);
  } catch (err) {
    console.error('Error fetching faculties:', err);
  }
}

// Display faculties in cards
function displayFaculties(faculties) {
  const container = document.getElementById('facultyList');
  container.innerHTML = '';

  faculties.forEach(fac => {
    const card = document.createElement('div');
    card.className = 'bg-white p-4 rounded-xl shadow-md hover:shadow-2xl hover:scale-105 transform transition duration-300 cursor-pointer';

    card.innerHTML = `
      <div class="flex justify-between items-center">
        <h3 class="font-bold text-lg">${fac.name}</h3>
      </div>
      <div class="facultyDetails hidden mt-2 text-sm text-gray-700">
        <p><strong>Email:</strong> ${fac.email}</p>
        <p><strong>Cabin:</strong> ${fac.cabin || 'N/A'}</p>
        <p><strong>Free Slots:</strong> ${fac.freeSlots || 'N/A'}</p>
        <p><strong>Note:</strong> ${fac.note || 'No note'}</p>
      </div>
    `;

    card.addEventListener('click', (e) => {
      if(e.target.tagName !== 'BUTTON') {
        const details = card.querySelector('.facultyDetails');
        details.classList.toggle('hidden');
      }
    });

    container.appendChild(card);
  });
}

// Faculty search filter
document.getElementById('facultySearch').addEventListener('input', async (e) => {
  const search = e.target.value.toLowerCase();
  try {
    const res = await fetch('https://where-is-my-faculty-backend.onrender.com/api/faculty', {
      headers: { 'Authorization': `Bearer ${studentToken}` }
    });
    const data = await res.json();
    const filtered = data.filter(f => f.name.toLowerCase().includes(search));
    displayFaculties(filtered);
  } catch (err) {
    console.error(err);
  }
});

// --- Fetch Clubs ---
async function fetchClubs() {
  try {
    const res = await fetch('https://where-is-my-faculty-backend.onrender.com/api/club/all', {
      headers: { 'Authorization': `Bearer ${studentToken}` }
    });
    const data = await res.json();
    displayClubs(data);
  } catch (err) {
    console.error('Error fetching clubs:', err);
  }
}

function displayClubs(clubs) {
  const container = document.getElementById('clubList');
  container.innerHTML = '';

  clubs.forEach(club => {
    const hasUpcomingEvents = club.events && club.events.length > 0;

    const card = document.createElement('div');
    card.className = 'bg-white p-4 rounded-xl shadow-md hover:shadow-2xl hover:scale-105 transform transition duration-300 cursor-pointer';
    
    card.innerHTML = `
      ${hasUpcomingEvents ? '<span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-2"></span>' : ''}
      <h3 class="font-bold text-lg">${club.clubName}</h3>
      <div class="clubEvents hidden mt-2 text-sm text-gray-700">
        ${
          hasUpcomingEvents
            ? club.events.map(ev => `
                <p>
                  ${ev.name} - ${new Date(ev.date).toLocaleDateString()} 
                  <span class="${ev.odProvided ? 'text-green-600 font-semibold' : 'text-red-500 font-semibold'}">
                    (${ev.odProvided ? '✅ OD Provided' : '❌ No OD'})
                  </span>
                </p>
              `).join('')
            : '<p>No upcoming events</p>'
        }
      </div>
    `;

    card.addEventListener('click', () => {
      const events = card.querySelector('.clubEvents');
      events.classList.toggle('hidden');
    });

    container.appendChild(card);
  });
}

// Initial fetch
fetchFaculties();
fetchClubs();
</script>

</body>
</html>
