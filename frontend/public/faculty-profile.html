<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Faculty Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- Navbar -->
<nav class="bg-blue-600 p-4 text-white flex justify-between items-center">
  <h1 class="text-xl font-bold">Faculty Dashboard</h1>
  <button id="logoutBtn" class="bg-red-500 px-3 py-1 rounded">Logout</button>
</nav>

<div class="container mx-auto p-6">
  <h2 class="text-2xl font-bold mb-4">Edit Your Availability</h2>

  <!-- Profile Form -->
  <form id="profileForm" class="bg-white p-6 rounded-2xl shadow-md space-y-6">

    <!-- Cabin -->
    <div>
      <label class="block font-semibold mb-1">Cabin Number:</label>
      <input type="text" id="cabin" class="border p-2 w-full rounded" placeholder="Enter your cabin">
    </div>

    <!-- Free Slots -->
    <div>
      <label class="block font-semibold mb-2">Select your Free Slots:</label>
      <div id="slots" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="flex items-center space-x-2">
          <input type="checkbox" value="8.30-10.00" class="slotToggle"> <span>8.30-10.00</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="checkbox" value="10.00-11.40" class="slotToggle"> <span>10.00-11.40</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="checkbox" value="11.40-1.15" class="slotToggle"> <span>11.40-1.15</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="checkbox" value="1.15-2.50" class="slotToggle"> <span>1.15-2.50</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="checkbox" value="2.50-4.20" class="slotToggle"> <span>2.50-4.20</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="checkbox" value="4.20-6.00" class="slotToggle"> <span>4.20-6.00</span>
        </label>
        <label class="flex items-center space-x-2">
          <input type="checkbox" value="6.00-7.30" class="slotToggle"> <span>6.00-7.30</span>
        </label>
      </div>
    </div>

    <!-- Note -->
    <div>
      <label class="block font-semibold mb-1">Special Note:</label>
      <textarea id="note" class="border p-2 w-full rounded" placeholder="Eg: Not available on Thursdays"></textarea>
    </div>

    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Save Changes</button>
  </form>
</div>

<script>
  const facultyToken = localStorage.getItem('facultyToken');

  // Load faculty data
  async function loadFaculty() {
    try {
      const res = await fetch('http://localhost:5000/api/faculty/me', {
        headers: { 'Authorization': `Bearer ${facultyToken}` }
      });
      const faculty = await res.json();

      // Populate form
      document.getElementById('cabin').value = faculty.cabin || '';
      document.getElementById('note').value = faculty.note || '';
      if (faculty.freeSlots) {
        faculty.freeSlots.forEach(slot => {
          const checkbox = document.querySelector(`input[value="${slot}"]`);
          if (checkbox) checkbox.checked = true;
        });
      }
    } catch (err) {
      console.error(err);
      alert("⚠️ Failed to load faculty profile");
    }
  }

  // Save changes
  document.getElementById('profileForm').addEventListener('submit', async e => {
    e.preventDefault();

    const cabin = document.getElementById('cabin').value;
    const note = document.getElementById('note').value;
    const freeSlots = Array.from(document.querySelectorAll('.slotToggle:checked')).map(cb => cb.value);

    try {
      const res = await fetch('http://localhost:5000/api/faculty/update', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${facultyToken}`
        },
        body: JSON.stringify({ cabin, freeSlots, note })
      });

      const data = await res.json();
      if (res.ok) {
        alert("✅ Profile updated successfully!");
        console.log("Updated:", data);
      } else {
        alert("❌ " + data.msg);
      }
    } catch (err) {
      console.error(err);
      alert("⚠️ Server error. Try again.");
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('facultyToken');
    window.location.href = '/faculty-login.html';
  });

  loadFaculty();
</script>

</body>
</html>
